<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸƒ í˜¸ë‘ë„¤ ê°€ê³„ë¶€</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
<style>
/* â”€â”€ ë””ìì¸ ì‹œìŠ¤í…œ (ë¯¼íŠ¸ í…Œë§ˆ) â”€â”€ */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
body{font-family:'Nanum Gothic',sans-serif;background:#A8E6CF;overflow-x:hidden}
::-webkit-scrollbar{display:none}

.app{max-width:820px;margin:0 auto;min-height:100vh;padding-bottom:100px;
  background:linear-gradient(180deg,#A8E6CF 0%,#DCEDC1 15%,#FEFCF3 35%,#FFF8E7 100%);
  position:relative;overflow:hidden}

.header{position:relative;z-index:1;padding:22px 24px 12px}
.title{font-size:24px;font-weight:800;color:#4E342E;margin-bottom:10px}
.month-bar{display:flex;gap:8px;overflow-x:auto;padding-bottom:10px}
.month-btn{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;border:1.5px solid #E8DFC8;background:#FFF8E7;color:#795548;white-space:nowrap;cursor:pointer;transition:0.2s}
.month-btn.active{background:#43AA8B;color:#fff;border-color:#43AA8B;box-shadow:0 4px 10px rgba(67,170,139,0.3)}

.content{padding:0 24px;animation:fadeIn 0.5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.card{background:#FEFCF3;border-radius:22px;padding:22px;margin-bottom:16px;border:2px solid #E8DFC8;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.card-title{font-size:16px;font-weight:800;color:#5D4037;margin-bottom:16px;display:flex;align-items:center;gap:6px}

/* í†µê³„ ê·¸ë¦¬ë“œ */
.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.stat-box{background:#fff;border-radius:16px;padding:14px;text-align:center;border:1px solid #F0E8D0}
.stat-label{font-size:11px;font-weight:700;color:#A1887F;margin-bottom:4px}
.stat-value{font-size:16px;font-weight:800;color:#4E342E}

/* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
.calendar-grid{display:grid;grid-template-columns:repeat(7, 1fr);gap:4px;text-align:center}
.cal-day-name{font-size:11px;color:#A1887F;font-weight:700;padding-bottom:8px}
.cal-cell{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:6px;border-radius:10px;font-size:12px;font-weight:600;color:#5D4037;position:relative}
.cal-cell.today{background:#43AA8B22;border:1.5px solid #43AA8B}
.cal-cell.payday::after{content:"ğŸ’°";font-size:10px;position:absolute;bottom:4px}
.cal-dot{width:4px;height:4px;border-radius:50%;margin-top:2px}

/* ë¶„ì„ ë­í‚¹ ìŠ¤íƒ€ì¼ */
.rank-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #E8DFC8}
.rank-row:last-child{border-bottom:none}
.rank-info{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:#5D4037}
.rank-bar-bg{flex:1;height:8px;background:#F0E8D0;border-radius:4px;margin:0 12px;overflow:hidden}
.rank-bar-fill{height:100%;border-radius:4px}

/* ì˜ˆì‚° ë§‰ëŒ€ */
.budget-row{margin-bottom:16px}
.budget-header{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px;font-weight:700;color:#5D4037}
.budget-track{height:14px;background:#E8DFC8;border-radius:7px;overflow:hidden}
.budget-fill{height:100%;transition:width 0.6s cubic-bezier(0.4,0,0.2,1)}

/* í•˜ë‹¨ íƒ­ë°” */
.tab-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:90%;max-width:400px;
  background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:10px 20px;border-radius:30px;
  display:flex;justify-content:space-between;box-shadow:0 8px 30px rgba(0,0,0,0.1);border:1px solid #fff;z-index:100}
.tab-btn{border:none;background:none;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;opacity:0.5;transition:0.2s}
.tab-btn.active{opacity:1;transform:scale(1.1)}
.tab-icon{font-size:22px}
.tab-label{font-size:10px;font-weight:700;color:#5D4037}

.loading{padding:60px;text-align:center;color:#795548;font-weight:bold}
.hidden{display:none}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="title">ğŸƒ í˜¸ë‘ë„¤ ê°€ê³„ë¶€</div>
    <div class="month-bar" id="month-bar"></div>
  </div>
  <div class="content" id="content"></div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" onclick="setTab('home')"><span class="tab-icon">ğŸ </span><span class="tab-label">í™ˆ</span></button>
  <button class="tab-btn" onclick="setTab('budget')"><span class="tab-icon">ğŸ“Š</span><span class="tab-label">ì˜ˆì‚°</span></button>
  <button class="tab-btn" onclick="setTab('history')"><span class="tab-icon">ğŸ“‹</span><span class="tab-label">ë‚´ì—­</span></button>
  <button class="tab-btn" onclick="setTab('savings')"><span class="tab-icon">ğŸï¸</span><span class="tab-label">ì €ì¶•</span></button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxar7X9K0bcG7T4Ll0x5CT8U7VwYLD-YT0Cmc2Qy7FqWKKDreN8wciEJlAEBGfplky2/exec";
const MONTHS = ["01","02","03","04","05","06","07","08","09","10","11","12"];

// 1. ì¹´í…Œê³ ë¦¬ & ì´ëª¨ì§€ ë§¤í•‘ (ì˜ˆì‚° íƒ­ ì ìš©)
const CAT_MAP = {
  "Groceries":"ğŸ ì‹ë£Œí’ˆ", "Dining":"ğŸ½ï¸ ì™¸ì‹", "Pet":"ğŸ± í˜¸ë‘",
  "Bill":"ğŸ“± ê³µê³¼ê¸ˆ", "Rent":"ğŸ  ì›”ì„¸", "ìƒí•„í’ˆ":"ğŸ§» ìƒí•„í’ˆ",
  "Gas":"â›½ ì£¼ìœ ", "ë³‘ì›":"ğŸ¥ ë³‘ì›", "ìš©ëˆ":"ğŸ’¸ ìš©ëˆ",
  "ì‡¼í•‘":"ğŸ›ï¸ ì‡¼í•‘", "ë¬¸í™”ìƒí™œ":"ğŸ¬ ë¬¸í™”", "ê¸°íƒ€":"ğŸ“¦ ê¸°íƒ€"
};
const COLOR_MAP = {
  "Groceries":"#FF6B6B", "Dining":"#FFA502", "Pet":"#ECCC68",
  "Bill":"#70A1FF", "Rent":"#5352ED", "ìƒí•„í’ˆ":"#FF7F50",
  "Gas":"#3742FA", "ë³‘ì›":"#FF4757", "ìš©ëˆ":"#2ED573",
  "ì‡¼í•‘":"#E056FD", "ë¬¸í™”ìƒí™œ":"#1E90FF", "ê¸°íƒ€":"#CED6E0"
};

// 2. 2026ë…„ ì›”ê¸‰ë‚  ë°ì´í„° (2ì£¼ ê°„ê²© ëª©ìš”ì¼)
const PAYDAYS = [
  "2026-01-08","2026-01-22","2026-02-05","2026-02-19","2026-03-05","2026-03-19",
  "2026-04-02","2026-04-16","2026-04-30","2026-05-14","2026-05-28","2026-06-11",
  "2026-06-25","2026-07-09","2026-07-23","2026-08-06","2026-08-20","2026-09-03",
  "2026-09-17","2026-10-01","2026-10-15","2026-10-29","2026-11-12","2026-11-26",
  "2026-12-10","2026-12-24"
];

let state = {
  month: String(new Date().getMonth()+1).padStart(2,"0"),
  tab: "home",
  data: { transactions:[], budget:[], savings:[] },
  loading: true
};

async function fetchData() {
  state.loading = true; render();
  try {
    const res = await fetch(API_URL);
    const json = await res.json();
    state.data = json;
  } catch(e) { console.error(e); }
  state.loading = false; render();
}

function setTab(t) {
  state.tab = t;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="setTab('${t}')"]`).classList.add('active');
  render();
}

function setMonth(m) { state.month = m; render(); }
function $(n) { return "$" + Number(n).toLocaleString(); }

/* â”€â”€â”€ ë Œë”ë§ í•µì‹¬ ë¡œì§ â”€â”€â”€ */
function render() {
  const content = document.getElementById("content");
  
  // ì›” ì„ íƒ ë°”
  document.getElementById("month-bar").innerHTML = MONTHS.map(m => 
    `<button class="month-btn ${state.month===m?'active':''}" onclick="setMonth('${m}')">${parseInt(m)}ì›”</button>`
  ).join("");

  if(state.loading) {
    content.innerHTML = '<div class="loading">ğŸƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</div>';
    return;
  }

  const txs = state.data.transactions.filter(t => t.m === state.month);
  
  // 1. í™ˆ íƒ­ (ìœ„ì¹˜ ë³€ê²½ë¨: í˜„í™© ìœ„ë¡œ, ë‹¬ë ¥ ì•„ë˜ë¡œ)
  if (state.tab === "home") {
    const inc = txs.filter(t=>t.t==="ìˆ˜ì…").reduce((a,b)=>a+b.amt,0);
    const exp = txs.filter(t=>t.t==="ì§€ì¶œ").reduce((a,b)=>a+b.amt,0);
    const sav = txs.filter(t=>t.t==="ì €ì¶•").reduce((a,b)=>a+b.amt,0);
    
    content.innerHTML = `
      <div class="card">
        <div class="card-title">ğŸ“Š ì´ë²ˆ ë‹¬ í˜„í™©</div>
        <div class="stat-grid">
          <div class="stat-box"><div class="stat-label">ìˆ˜ì…</div><div class="stat-value" style="color:#2E7D32">${$(inc)}</div></div>
          <div class="stat-box"><div class="stat-label">ì§€ì¶œ</div><div class="stat-value" style="color:#C62828">${$(exp)}</div></div>
          <div class="stat-box"><div class="stat-label">ì €ì¶•</div><div class="stat-value" style="color:#1565C0">${$(sav)}</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“… ${parseInt(state.month)}ì›” ë‹¬ë ¥</div>
        ${renderCalendar(state.month, txs)}
      </div>
    `;
  } 
  
  // 2. ì˜ˆì‚° íƒ­ (ì´ëª¨ì§€ ì ìš©)
  else if (state.tab === "budget") {
    const expenses = txs.filter(t=>t.t==="ì§€ì¶œ");
    const spentMap = {};
    expenses.forEach(t => {
      // ì¹´í…Œê³ ë¦¬ ë§¤í•‘ (ì§€ì¶œ_Groceries -> Groceries)
      let key = t.cat.replace("ì§€ì¶œ_","").replace("ê³ ì •_","");
      spentMap[key] = (spentMap[key]||0) + t.amt;
    });

    content.innerHTML = `
      <div class="card">
        <div class="card-title">ğŸ“‰ ì¹´í…Œê³ ë¦¬ë³„ ì˜ˆì‚°</div>
        ${state.data.budget.map(b => {
          const spent = spentMap[b.category] || 0;
          const pct = Math.min((spent/b.target)*100, 100);
          const info = CAT_MAP[b.category] || b.category; // ì´ëª¨ì§€ ë§¤í•‘
          const color = COLOR_MAP[b.category] || "#43AA8B";
          
          return `
            <div class="budget-row">
              <div class="budget-header">
                <span>${info}</span>
                <span style="color:${spent>b.target?'#C62828':'#5D4037'}">${$(spent)} / ${$(b.target)}</span>
              </div>
              <div class="budget-track">
                <div class="budget-fill" style="width:${pct}%;background:${spent>b.target?'#FF6B6B':color}"></div>
              </div>
            </div>`;
        }).join("")}
      </div>`;
  }
  
  // 3. ë‚´ì—­ íƒ­ (ì°¨íŠ¸ + ì¹´ë“œë³„ + ì‚¬ìš©ìë³„ ë¶„ì„)
  else if (state.tab === "history") {
    const expenses = txs.filter(t=>t.t==="ì§€ì¶œ");
    
    // ë°ì´í„° ê°€ê³µ
    const byCat = groupBy(expenses, t => t.cat.replace("ì§€ì¶œ_","").replace("ê³ ì •_",""));
    const byCard = groupBy(expenses, t => t.pay ? t.pay.split("_")[1] || "ê¸°íƒ€" : "ê¸°íƒ€");
    const byUser = groupBy(expenses, t => t.pay ? t.pay.split("_")[0] || "ê³µë™" : "ê³µë™");
    
    content.innerHTML = `
      <div class="card">
        <div class="card-title">ğŸ¥§ ì§€ì¶œ ë¹„ìœ¨</div>
        <div style="display:flex;justify-content:center;margin:20px 0">
          ${renderDonutChart(byCat)}
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ† í•­ëª©ë³„ ì§€ì¶œ ìˆœìœ„</div>
        ${renderRanking(byCat, "cat")}
      </div>

      <div class="card">
        <div class="card-title">ğŸ’³ ì¹´ë“œë³„ ì‚¬ìš© ê¸ˆì•¡</div>
        ${renderRanking(byCard, "card")}
      </div>

      <div class="card">
        <div class="card-title">ğŸ‘¥ ì‚¬ìš©ìë³„ ì§€ì¶œ (ë‚˜ vs í˜¸ì½¤)</div>
        ${renderRanking(byUser, "user")}
      </div>
    `;
  }
  
  // 4. ì €ì¶• íƒ­ (ì™€ì´ì–´ë°”ì¼ë¦¬ ì œê±°)
  else if (state.tab === "savings") {
    const total = state.data.savings.reduce((a,b)=>a+b.balance,0);
    content.innerHTML = `
      <div class="card" style="background:#43AA8B;color:#fff;text-align:center">
        <div style="font-size:14px;opacity:0.9">ì´ ìì‚°</div>
        <div style="font-size:30px;font-weight:800;margin-top:5px">${$(total)}</div>
      </div>
      <div class="card">
        <div class="card-title">ğŸï¸ ê³„ì¢Œë³„ í˜„í™©</div>
        ${state.data.savings.map(s => `
          <div class="rank-row">
            <div style="font-weight:700;color:#5D4037">${s.name}</div>
            <div style="font-weight:800;color:#2E7D32">${$(s.balance)}</div>
          </div>
        `).join("")}
      </div>
    `;
  }
}

/* â”€â”€â”€ í—¬í¼ í•¨ìˆ˜ë“¤ â”€â”€â”€ */

// ë‹¬ë ¥ ê·¸ë¦¬ê¸°
function renderCalendar(monthStr, txs) {
  const year = 2026;
  const month = parseInt(monthStr) - 1;
  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();
  const todayStr = new Date().toISOString().split("T")[0];
  
  let html = `<div class="calendar-grid">`;
  ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(d => html += `<div class="cal-day-name">${d}</div>`);
  
  for(let i=0; i<firstDay; i++) html += `<div></div>`;
  
  for(let d=1; d<=lastDate; d++) {
    const dateStr = `${year}-${monthStr}-${String(d).padStart(2,"0")}`;
    const isPayday = PAYDAYS.includes(dateStr);
    const dayTxs = txs.filter(t => t.date && t.date.startsWith(dateStr));
    const hasExpense = dayTxs.some(t => t.t === "ì§€ì¶œ");
    
    html += `
      <div class="cal-cell ${dateStr===todayStr?'today':''} ${isPayday?'payday':''}">
        <span>${d}</span>
        ${hasExpense ? '<div class="cal-dot" style="background:#FF6B6B"></div>' : ''}
      </div>`;
  }
  html += `</div>`;
  return html;
}

// ê·¸ë£¹í™” ë° ì •ë ¬ í•¨ìˆ˜
function groupBy(arr, keyFn) {
  const map = {};
  arr.forEach(t => {
    const k = keyFn(t);
    map[k] = (map[k] || 0) + t.amt;
  });
  return Object.entries(map).sort((a,b) => b[1] - a[1]);
}

// ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
function renderRanking(data, type) {
  if(!data.length) return '<div style="text-align:center;color:#999;padding:10px">ë‚´ì—­ ì—†ìŒ</div>';
  const max = data[0][1];
  return data.map(([key, val]) => {
    let label = key;
    let color = "#43AA8B";
    if(type === "cat") { label = CAT_MAP[key] || key; color = COLOR_MAP[key] || color; }
    
    return `
      <div class="rank-row">
        <div style="width:80px;font-size:12px;color:#5D4037;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${label}</div>
        <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${(val/max)*100}%;background:${color}"></div></div>
        <div style="width:60px;text-align:right;font-size:12px;font-weight:800">${$(val)}</div>
      </div>`;
  }).join("");
}

// ë„ë„› ì°¨íŠ¸ (SVG)
function renderDonutChart(data) {
  if(!data.length) return "";
  let total = data.reduce((a,b)=>a+b[1],0);
  let cum = 0;
  const size = 160, r = 70, cx = 80, cy = 80;
  
  const paths = data.slice(0, 5).map(([key, val]) => {
    const ratio = val / total;
    if(ratio < 0.01) return ""; 
    const startAngle = cum * Math.PI * 2;
    const endAngle = (cum + ratio) * Math.PI * 2;
    cum += ratio;
    
    const x1 = cx + r * Math.cos(startAngle - Math.PI/2);
    const y1 = cy + r * Math.sin(startAngle - Math.PI/2);
    const x2 = cx + r * Math.cos(endAngle - Math.PI/2);
    const y2 = cy + r * Math.sin(endAngle - Math.PI/2);
    
    const color = COLOR_MAP[key] || "#ddd";
    const largeArc = ratio > 0.5 ? 1 : 0;
    
    return `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z" fill="${color}" stroke="#fff" stroke-width="2"/>`;
  });

  return `
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      ${paths.join("")}
      <circle cx="${cx}" cy="${cy}" r="35" fill="#fff"/>
      <text x="${cx}" y="${cy+5}" text-anchor="middle" font-size="12" font-weight="bold" fill="#5D4037">Total</text>
    </svg>`;
}

// ì´ˆê¸° ì‹¤í–‰
fetchData();

// ğŸµ BGM (ê¸°ì¡´ ìœ ì§€)
const bgm = new Audio('bgm.mp3'); bgm.loop = true;
document.addEventListener('click', () => { if(bgm.paused) bgm.play(); }, { once: true });
</script>
</body>
</html>
